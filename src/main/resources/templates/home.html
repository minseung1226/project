<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>홈앤룸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

<style>
    a {
        text-decoration: none; /* 밑줄 제거 */
        color: inherit; /* 링크의 기본 색상 유지 */
    }
    a.a-card:hover{
        background-color: black;
    }

    .container-fluid.room-list {
        overflow-y: auto;
        max-height: 850px; /* 스크롤이 표시될 최대 높이 */
    }



</style>
</head>
<body>


<header th:replace="templates/header :: header_template"></header>
<div th:if="${session.user==null}">
    <div th:replace="templates/header :: header_modal"></div>
</div>
<div class="container-fluid main" style="height:890px">
    <div class="row" style="height: 100%">
        <div class="col-8 fluid" style="padding: 0">
            <div id="map" style="width:100%;height:100%; padding: 0"></div>

        </div>
        <div class="col-4">
            <div class="container-fluid" style="padding: 0">
                <div class="row p-2 bg-secondary justify-content-center">
                    <div class="col-2"></div>
                    <div class="col-6">
                        <input class="form-control me-2" id="search" type="search" placeholder="지역,지하철명"
                               aria-label="Search">
                    </div>
                    <div class="col-4">
                        <button id="search_btn" class="btn btn-dark " type="button" onclick="search()">Search</button>
                    </div>
                </div>
                <div class="row border-bottom">

                    <div class="col-6">
                        <div class="btn-group">
                            <button type="button" class="btn btn dropdown-toggle" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                상세검색
                            </button>
                            <div class="dropdown-menu">
                                <div class="row">
                                    <div class="col-4">
                                        안녕
                                    </div>
                                    <div class="col-8">
                                        <div>메롱</div>
                                        <div>병신</div>
                                    </div>
                                </div>
                            </div>
                            <hr>

                        </div>
                    </div>
                    <div class="col-6 float-right">
                        닫기
                    </div>
                </div>
                <div class="container-fluid room-list">

                </div>
            </div>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=aad77ce5fb25c098c085b83a13dbad40&libraries=services,clusterer"></script>
<script th:inline="javascript">
    function createRoomHtml(data){
        let html=`<div class="row">`
        for(let i=0;i<data.length;i++){
            let title=data[i].title.toString().substring(0,10)+"...";
            html +=`
    <div class="col-4 p-1">
      <a class="a-card" href="/room/detail/`+data[i].id+`" style="display: inline">
        <div class="card">
          <img src="/images/`+data[i].img+`" class="card-img-top" alt="..." width="100%" height="150px">
          <div class="card-body p-1 m-0">
            <p class="m-0"><h5 class="fw-bold">월세`+data[i].deposit+`/`+data[i].monthlyRent+`</h5></p>
            <p class="m-0">`+title+`</p>
            <p class="m-0" style="font-size: 13px">`+data[i].roomType+` | `+`관리비`+data[i].maintenance+`만원</p>
          </div>
        </div>
      </a>
    </div>
  `;
            if(i%3==2){
                html+=`</div><div class="row">`
            }
            if(i==data.length-1){
                html+=`</div>`;
            }
        }

        let container=document.querySelector(`.container-fluid.room-list`);
        container.innerHTML=html;
    };

    function roomCall(map){
        var bounds = map.getBounds();
        var swLatLng = bounds.getSouthWest(); // 서남쪽 좌표 (좌하단)
        var neLatLng = bounds.getNorthEast(); // 동북쪽 좌표 (우상단)

        // 서남쪽 좌표의 위도와 경도
        var swLat = swLatLng.getLat();
        var swLng = swLatLng.getLng();

        // 동북쪽 좌표의 위도와 경도
        var neLat = neLatLng.getLat();
        var neLng = neLatLng.getLng();

        // 위도와 경도 출력하기
        console.log('서남쪽 좌표:', swLat, swLng);
        console.log('동북쪽 좌표:', neLat, neLng);

        // 서버로 위도와 경도를 전달하여 매물 데이터를 요청하거나 처리할 수 있습니다.
        // 예를 들어 AJAX 요청을 사용하여 해당 영역의 매물 정보를 가져올 수 있습니다.

        $.ajax({
            type: 'get',
            url: '/room/roomList',
            data: {
                minLat: swLat,
                minLng: swLng,
                maxLat: neLat,
                maxLng: neLng
            }
        }).done(function (data) {
            let markers=$(data).map(function (i,form){
                return new kakao.maps.Marker({
                    position:new kakao.maps.LatLng(form.lat,form.lng)
                })
            });

            let clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 1,
                minClusterSize: 1,
                markers: markers
            });


            createRoomHtml(data);



        }).fail(function (err) {
            alert(err);
        });
    }

    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(37.484661, 126.783171), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };

    // 지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption);

    roomCall(map);


    // 지도 이동이 완료되면 호출되는 이벤트 리스너 등록
    kakao.maps.event.addListener(map, 'idle', function () {
        // 현재 지도의 경계 영역 정보 가져오기
        roomCall(map);
    });

    function search() {
        // 장소 검색 객체를 생성합니다
        var ps = new kakao.maps.services.Places();

        // 키워드로 장소를 검색합니다
        ps.keywordSearch($('#search').val(), placesSearchCB);

        // 키워드 검색 완료 시 호출되는 콜백함수 입니다
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {

                // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                // LatLngBounds 객체에 좌표를 추가합니다
                var bounds = new kakao.maps.LatLngBounds();

                bounds.extend(new kakao.maps.LatLng(data[0].y, data[0].x));

                // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
                map.setBounds(bounds);
            }
        }
    }


</script>

</body>
</html>